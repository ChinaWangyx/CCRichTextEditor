<html>
<script type="text/javascript">
  console = new Object();
  console.log = function(log) {
    var iframe = document.createElement("IFRAME");
    iframe.setAttribute("src", "ios-log:#iOS#" + log);
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
  }
  console.debug = console.log;
  console.info = console.log;
  console.warn = console.log;
  console.error = console.log;

  
		//show keyboard, if touch is in the div
document.addEventListener('touchend', function(e) { // Listen for touch end on the document
            // Get the touch and coordinates
	var touch = e.changedTouches.item(0);
	var touchX = touch.clientX;
	var touchY = touch.clientY;

		// Get the rect for the content  
	var contentDIVRect = document.getElementById('content').getClientRects()[0];
		
		//alert("left:" + contentDIVRect.left + " bottom:" +contentDIVRect.bottom
		//	+ "touchX:" + touchX + "touchY:" + touchY);

		// Make sure we don't block touches to the content div
	if (touchX > contentDIVRect.left && touchY < contentDIVRect.bottom) {
		return;
	}
	
	// If the touch is out of the content div then simply give the div focus
	document.getElementById('content').focus();                    
	console.log("touched");
}, false);


//if (!window.WebKitMutationObserver) {    //ios6 有，ios5没有
//	var timer;
//	document.addEventListener('DOMAttrModified', function(e) {
//		clearTimeout(timer);
//		timer = setTimeout(function () {
//			//callback scroll view
//
//			fire('DOMSubtreeModified');
//    }, 50);
//	}, false);
//}

function getCaretPosition() {
	var sel = window.getSelection();
	var range = sel.getRangeAt(0);	
	var rects, rect;
	var hasFakeNode = false;
	try {
		if (sel.focusNode.nodeType != 3) {      //text == 3
			var newNode = document.createTextNode("-");
			
			if (sel.focusNode.querySelector('br')) {
				range.insertNode(newNode);
				rects = range.getClientRects();
				rect = rects[0];
				hasFakeNode = true;
			}
			else {
				rects = range.getClientRects();
				if (!rects.length) {                //插入图片后，获取的rects为空数组
					range.insertNode(newNode);
					rects = range.getClientRects();
					hasFakeNode = true;
				}
				rect = rects[0];
			}
		}
		else {
			rects = range.getClientRects();
			rect = rects[0];
		}

		var offsetY = rect.top + rect.height;
		if (hasFakeNode)
			range.deleteContents();

		console.log(offsetY);

		return offsetY;
	}
	catch (e) {
		alert(e);
	}
}

function moveImageAtTo(x, y, newX, newY) {
		// Get our required variables
	var element  = document.elementFromPoint(x, y);
	if (element.tagName.toString() != "IMG") {
			// Attempt to move an image which doesn't exist at the point
		return;
	}
		// Save the image source so we know this later when we need to re-insert it
	var imageSrc = element.src;
	var selection = window.getSelection();

		// Set the selection to the range of the image, so we can delete it
	var nodeRange = document.createRange();
	nodeRange.selectNode(element);
	if (selection.rangeCount) selection.removeAllRanges();
	selection.addRange(nodeRange);
		
	// Delete the image
	document.execCommand('delete');
	
	// Set the selection to the caret range, so we can then add the image
	selection = window.getSelection();
	var caretRange = document.caretRangeFromPoint(newX, newY);
	if (selection.rangeCount) selection.removeAllRanges();
	selection.addRange(caretRange);
	
	// Re-insert the image
	document.execCommand('insertImage', false, imageSrc);
}
</script>
    <body>
        <style type="text/css">
          #content { background-color:transparent; font-family:simsun; }
        </style>
        <div id="content" contenteditable="true">This is out Rich Text Editing View </div>
    </body>
</html>
